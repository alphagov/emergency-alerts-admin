<script src="{{ asset_url('javascripts/leaflet.js') }}"></script>
<script src="{{ asset_url('javascripts/Leaflet.Editable.js') }}"></script>
<script src="{{ asset_url('javascripts/proj4.js') }}"></script>
<script src="{{ asset_url('javascripts/customMapping.js') }}"></script>

<script>
  proj4.defs("EPSG:27700",
      "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs +type=crs");
  let mapElement = document.getElementById('area-list-map');
  const markerIcon = L.icon({
    iconUrl:"{{ asset_url('images/marker-icon.png') }}",
    iconSize: [30, 30],
  });
  mapElement.style.height = Math.max(400, window.innerHeight - mapElement.offsetTop - 100) + 'px';
  let radius = document.getElementById('radius');
  let area_list = document.querySelector('.area-list');
  let radius_value = radius.value * 1000;
  let method;
  let coordinate_type;
  let centroid;
  let marker;
  let bleed;
  let bleed_radius;
  let postcode;
  let circle;

  {% if bleed %}
    bleed = parseFloat({{bleed}});
    bleed_radius = radius_value + bleed;
  {% endif %}

  {% if centroid %}
    centroid = [{{centroid[0]}}, {{centroid[1]}}];
  {% endif %}

  {% if is_postcode %}
    let is_postcode = true;
  {% else %}
    let is_postcode = false;
  {% endif %}

  {% if postcode %}
    postcode = "{{postcode}}".toUpperCase();
  {% endif %}

  {% if method %}
    method = "{{method}}";
  {% endif %}

  {% if coordinate_type %}
    coordinate_type = "{{coordinate_type}}";
  {% endif %}

  let mymap = L.map(
    'area-list-map',
    {
      editable: true,
      scrollWheelZoom: false,
    }
  )
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(mymap);

  mymap.setView(
    [55.378052, -3.435973],
    5
  );

  mymap.on("editable:vertex:drag", onDragUpdates);

  mymap.on("editable:vertex:dragend", function (e) {
    mymap.fitBounds(
      bleed_circle.getBounds(),
      {padding: [1, 1]}
    );
    updateCountOfPhones('Calculating...');
    $.ajax({
      method: "POST",
      url: "get_custom_area_params",
      headers: { 'X-CSRFToken': "{{ csrf_token() }}" },
      data: { radius: circle.getRadius()/1000, first_coordinate: document.getElementById('first_coordinate').value,
        second_coordinate: document.getElementById('second_coordinate').value},
      error: function parseError(errorThrown) {
        console.log('Error: ', errorThrown.statusText);
        updateCountOfPhones('Unknown number of phones');
      },
      success: function updateParams(response) {
        bleed_circle.setRadius(e.layer._mRadius+response.bleed);
        phones_label = response.count_of_phones.toLocaleString('en-GB')+" to "+response.count_of_phones_likely.toLocaleString('en-GB')+" phones";
        updateCountOfPhones(phones_label);
        updateEstimatedAreaText('An area of '+response.estimated_area+' square miles&nbsp;');
        updateEstimatedBleedAreaText('An extra area of '+response.estimated_area_with_bleed+' square miles is&nbsp;');
      }
    })
  });

  // mymap.on("editable:editing", function (e) {
  //  limitingRadius(e, circle, bleed_circle);
  // });

  if (method == 'radius') {
    if (coordinate_type == 'latitude_longitude'){
      createLatitudelongitudeArea(L, first_coordinate.value, second_coordinate.value, radius_value, bleed_radius, mapElement);
    } else if (coordinate_type == 'easting_northing'){
      createEastingNorthingArea(L, proj4, first_coordinate.value, second_coordinate.value, radius_value, bleed_radius, mapElement);
    } else if (is_postcode) {
      createPostcodeArea(L, centroid, radius_value, bleed_radius, mapElement, postcode);
    }
    addingFeaturesToMap(L, L.Editable, mymap, bleed_circle, circle, pinpoint);
  } else if (method == 'search') {
    addingPostcodeCentroidMarkerToMap(L, L.Editable, mymap, centroid);
  }
</script>
