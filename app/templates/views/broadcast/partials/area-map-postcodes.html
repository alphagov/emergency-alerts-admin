<script src="{{ asset_url('javascripts/leaflet.js') }}"></script>
<script src="{{ asset_url('javascripts/proj4.js') }}"></script>

<script>

  let pinpoint
  let circle
  let has_areas = false
  let has_marker = false
  const markerIcon = L.icon({
    iconUrl:"{{ asset_url('images/marker-icon.png') }}",
    iconSize: [30, 30],
  });

  {% if broadcast_message.areas %}
    has_areas = true
  {% endif %}

  {% if marker %}
    has_marker = true
  {% endif %}

  let mapElement = document.getElementById('area-list-map');
  mapElement.style.height = Math.max(400, window.innerHeight - mapElement.offsetTop - 100) + 'px';
  let radius = document.getElementById('radius');

  function getCoordinateType() {
    const pageUrl = window.location.href;
    if (pageUrl.includes('cartesian')) {
      return 'cartesian';
    } else if (pageUrl.includes('decimal')) {
      return 'decimal';
    } else if (pageUrl.includes('postcodes')) {
      return 'postcode';
    }
  }

  function eastingsNorthingsToLatLng(easting, northing) {
    proj4.defs("EPSG:27700",
    "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs +type=crs");
    const latlng = proj4('EPSG:27700', 'EPSG:4326', [easting, northing]);
    return {lat: latlng[1], lng: latlng[0]}
  }

  function latLngToEastingsNorthings(lat, lng) {
    proj4.defs("EPSG:27700",
    "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs +type=crs");
    const eastingnorthing = proj4('EPSG:4326', 'EPSG:27700',[lng, lat]);
    return {easting: eastingnorthing[0], northing: eastingnorthing[1]}
  }

  function createAreaCircle(coordinates, radius) {
    return L.circle(coordinates, radius, {
      color: '#0b0b0c',
      fillColor: 'none',
      fillOpacity: 0.3,
      weight: 2,
    })
  }

  function createBleedCircle(coordinates, bleed_radius) {
    return L.circle(coordinates, bleed_radius, {
      color: '#5694ca',
      fillColor: 'none',
      fillOpacity: 0.3,
      dashArray: '4,7.5,5,7.5,8,8,5,8,7.5,8,5,8,7,8,5,8,4',
      weight: 2,
    })
  }

  let mymap = L.map(
  'area-list-map',
  {
    scrollWheelZoom: false,
    editable: true

  }
  )
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(mymap);


  mymap.setView(
      [55.378052, -3.435973],
      5
    );

  if (has_areas) {
    radius_value = radius.value * 1000;
    bleed_radius = radius_value + {{bleed}};
    type = getCoordinateType();
    if (type == 'postcode') {
      circle = createAreaCircle({{centroid}}, radius.value * 1000);
      bleed_circle = createBleedCircle({{centroid}}, bleed_radius);
      pinpoint = L.marker({{centroid}}, {icon: markerIcon});
    } else if (type == 'decimal'){
      circle = createAreaCircle([first_coordinate.value, second_coordinate.value], radius_value);
      bleed_circle = createBleedCircle([first_coordinate.value, second_coordinate.value], bleed_radius);
      pinpoint = L.marker([first_coordinate.value, second_coordinate.value], {icon: markerIcon});
    } else if (type == 'cartesian'){
      latlngs = eastingsNorthingsToLatLng(parseFloat(first_coordinate.value), parseFloat(second_coordinate.value));
      circle = createAreaCircle([latlngs.lat, latlngs.lng], radius_value);
      bleed_circle = createBleedCircle([latlngs.lat, latlngs.lng], bleed_radius);
      pinpoint = L.marker([latlngs.lat, latlngs.lng], {icon: markerIcon});
    }
    bleed_circle.addTo(mymap);
    circle.addTo(mymap);
    pinpoint.addTo(mymap);
    mymap.fitBounds(
      bleed_circle.getBounds(),
      {padding: [1, 1]}
    );
  } else if (has_marker) {
    pinpoint = L.marker({{marker}}, {icon: markerIcon});
    pinpoint.addTo(mymap);
    mymap.setView(pinpoint.getLatLng(), 13);
  }

</script>
