version: 0.2

phases:
  install:
    commands:
      - mkdir -vp ~/.docker/cli-plugins/
      - curl --silent -L "https://github.com/docker/buildx/releases/download/v0.3.0/buildx-v0.3.0.linux-amd64" > ~/.docker/cli-plugins/docker-buildx
      - chmod a+x ~/.docker/cli-plugins/docker-buildx
  pre_build:
    commands:
      - docker buildx create --name builder
      - docker buildx use builder
  build:
    commands:
      - bash ./scripts/docker-build.sh --ENVIRONMENT development --IMAGE admin --ARGS '--push'
  post_build:
    commands:
      - printf '[{"name":"$CONTAINER_NAME","imageUri":"%s"}]' $REPOSITORY_URI:latest > imageDetail.json

artifacts:
  files:
    - 'imageDetail.json'
    - '.codepipeline/appspec.yml'
    - '.codepipeline/taskdef.json'
  secondary-artifacts:
    BuildArtifact:
      files:
        - imageDetail.json
        - appspec.yml
        - taskdef.json
